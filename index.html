<script>
    const MASTER_SERIAL = "SK-9288-XPQ2-LNT0";
    let apiKey = localStorage.getItem('user_api_key') || "";
    let base64Image = "";

    // PROMPT ASLI KAMU (Jangan diubah agar outputnya pas)
    const systemPrompt = `Kamu adalah Creative Director & Psikolog Marketing kelas dunia. Tugasmu membuat 10 script jualan viral. WAJIB Output JSON: [{"hook": "...", "body": "...", "visual": "...", "caption": "...", "hashtags": "..."}]`;

    function unlockApp() {
        const sn = document.getElementById('gate-pass').value.trim().toUpperCase();
        const ak = document.getElementById('gate-key').value.trim();
        if(sn === MASTER_SERIAL && ak.startsWith("AIza")) {
            localStorage.setItem('user_api_key', ak);
            localStorage.setItem('is_activated', 'true');
            location.reload();
        } else { alert("Data Salah!"); }
    }

    if(localStorage.getItem('is_activated')) {
        document.getElementById('gatekeeper').remove();
        document.getElementById('app-content').classList.remove('hidden-gate');
    }

    function logout() { localStorage.clear(); location.reload(); }

    function previewImage(i) {
        const r = new FileReader();
        r.onload = e => { 
            document.getElementById('img-preview').src = e.target.result;
            document.getElementById('img-preview').classList.remove('hidden');
            document.getElementById('drop-ui').classList.add('hidden');
            base64Image = e.target.result.split(',')[1];
        };
        r.readAsDataURL(i.files[0]);
    }

    async function generateScripts() {
        const btn = document.getElementById('btn-gen');
        btn.disabled = true; btn.innerText = "MERACIK NASKAH...";
        
        // KITA PAKAI MODEL 2.5 FLASH PREVIEW (Sesuai kode awalmu)
        const modelName = "gemini-2.5-flash-preview-09-2025";
        
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    contents: [{ 
                        parts: [
                            { text: `Produk: ${document.getElementById('inp-desc').value}, Audiens: ${document.getElementById('inp-target').value}, Durasi: ${document.getElementById('inp-duration').value}, Tone: ${document.getElementById('inp-tone').value}. Buat 10 script.` },
                            ...(base64Image ? [{inlineData:{mimeType:"image/png",data:base64Image}}] : [])
                        ] 
                    }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { 
                        responseMimeType: "application/json",
                        temperature: 0.7 
                    }
                })
            });

            if (!res.ok) throw new Error();

            const data = await res.json();
            const scripts = JSON.parse(data.candidates[0].content.parts[0].text);
            renderResults(scripts);
            saveLocal(scripts);
        } catch (e) {
            // JIKA PREVIEW ERROR, KITA OTOMATIS COBA MODEL STABIL 1.5
            console.log("Switching to fallback model...");
            try {
                const fallback = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Produk: ${document.getElementById('inp-desc').value}. Buat 10 script jualan. JSON: [{"hook":"","body":"","visual":"","caption":"","hashtags":""}]` }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const d = await fallback.json();
                renderResults(JSON.parse(d.candidates[0].content.parts[0].text));
            } catch (err2) {
                alert("API Error! Cek limitasi API Key kamu di Google AI Studio.");
            }
        } finally {
            btn.disabled = false; btn.innerText = "BUAT 10 SCRIPT SIAP JUALAN";
            lucide.createIcons();
        }
    }

    // FUNGSI RENDER DLL TETAP SAMA AGAR FITUR TIDAK HILANG
    function renderResults(scripts) {
        document.getElementById('results-list').innerHTML = scripts.map((s, idx) => `
            <div class="glass-card rounded-[2.5rem] p-8 space-y-6 mb-8">
                <div class="flex justify-between items-center border-b border-white/5 pb-4">
                    <span class="bg-indigo-600 text-[9px] font-black px-3 py-1.5 rounded-lg uppercase italic">SCRIPT #${idx+1}</span>
                    <button onclick="navigator.clipboard.writeText(\`HOOK: \${s.hook}\\nBODY: \${s.body}\`)" class="p-2 text-indigo-500"><i data-lucide="copy" class="w-4 h-4"></i></button>
                </div>
                <h2 class="text-2xl font-black italic leading-tight">"\${s.hook}"</h2>
                
                <div class="flex flex-col md:flex-row gap-4">
                    <select id="v-\${idx}" class="input-style p-3 rounded-xl text-[10px] flex-1 font-bold">
                        <option value="Kore">Kore (Cowo)</option>
                        <option value="Leda">Leda (Cewe)</option>
                        <option value="Fenrir">Fenrir (Cowo Savage)</option>
                        <option value="Aoede">Aoede (Cewe Soft)</option>
                    </select>
                    <button onclick="playTTS('\${s.hook}. \${s.body}', \${idx})" id="b-v-\${idx}" class="bg-indigo-600 px-6 py-3 rounded-xl text-[10px] font-black uppercase">Play Suara</button>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <span class="text-[9px] font-black text-slate-500 uppercase">Script Suara</span>
                        <div class="p-5 bg-black/40 rounded-2xl text-sm italic opacity-80 border border-white/5">\${s.body}</div>
                    </div>
                    <div class="space-y-2">
                        <span class="text-[9px] font-black text-yellow-500 uppercase">Visual Directing</span>
                        <div class="p-5 bg-yellow-500/5 rounded-2xl text-[11px] border border-yellow-500/20 text-yellow-200">\${s.visual}</div>
                    </div>
                </div>

                <div class="p-6 bg-indigo-500/5 rounded-[2rem] space-y-2 border border-indigo-500/10">
                    <span class="text-[9px] font-black text-pink-500 uppercase">Caption</span>
                    <p class="text-[11px] opacity-70">\${s.caption}</p>
                    <p class="text-[11px] font-bold text-indigo-400 mt-2">\${s.hashtags}</p>
                </div>
            </div>`).join('');
        lucide.createIcons();
    }

    // PlayTTS, saveLocal, switchTab (Gunakan yang di kode sebelumnya)
</script>
